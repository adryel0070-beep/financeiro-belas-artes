<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Financeiro do Aluno</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>
</head>

<body>

<h1>Financeiro do Aluno</h1>
<h2 id="nomeAluno"></h2>

<!-- =========================
 CADASTRO DE MENSALIDADE (CONTRATO)
========================= -->

<form id="formMensalidade" class="form">

<label>
Valor da Mensalidade
<input type="number" step="0.01" id="valor" required>
</label>

<label>
Dia do Vencimento
<input type="number" id="vencimento" min="1" max="28" required>
</label>

<label>
Início da Vigência
<input type="month" id="inicio" required>
</label>

<label>
Fim da Vigência
<input type="month" id="fim" required>
</label>

<button type="submit">Salvar Mensalidade</button>

</form>

<p id="msg"></p>

<hr>

<!-- =========================
 HISTÓRICO FINANCEIRO
========================= -->

<h2>Histórico Financeiro</h2>

<table>
<thead>
<tr>
<th>Competência</th>
<th>Valor</th>
<th>Vencimento</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'

const params = new URLSearchParams(window.location.search)
const alunoId = params.get('id')

const nomeAluno = document.getElementById('nomeAluno')
const tabela = document.getElementById('tabela')
const msg = document.getElementById('msg')

/* ========================
 CARREGAR ALUNO
======================== */

async function carregarAluno(){
  const { data } = await supabase
    .from('alunos')
    .select('nome')
    .eq('id', alunoId)
    .single()

  nomeAluno.innerText = data.nome
}

carregarAluno()

/* ========================
 SALVAR MENSALIDADE (REGRA)
======================== */

document.getElementById('formMensalidade')
.addEventListener('submit', async (e) => {

  e.preventDefault()
  msg.innerText = ''

  const valor = Number(document.getElementById('valor').value)
  const dia = Number(document.getElementById('vencimento').value)
  const inicio = document.getElementById('inicio').value
  const fim = document.getElementById('fim').value

  if(inicio > fim){
    msg.innerText = 'Fim da vigência não pode ser menor que o início'
    msg.style.color = 'red'
    return
  }

  const { error } = await supabase
    .from('mensalidades')
    .insert({
      aluno_id: alunoId,
      valor,
      dia_vencimento: dia,
      data_inicio: inicio + '-01',
      data_fim: fim + '-01'
    })

  if(error){
    msg.innerText = 'Erro ao salvar mensalidade'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Mensalidade cadastrada com sucesso'
  msg.style.color = 'green'

  carregarHistorico()
})

/* ========================
 GERAR COMPETÊNCIAS
======================== */

function gerarCompetencias(inicio, fim){
  const lista = []
  let atual = new Date(inicio)
  const dataFim = new Date(fim)

  while(atual <= dataFim){
    lista.push(new Date(atual))
    atual.setMonth(atual.getMonth() + 1)
  }

  return lista
}

/* ========================
 STATUS AUTOMÁTICO
======================== */

function calcularStatus(comp, diaVencimento, pago){
  if(pago) return 'Pago'

  const hoje = new Date()
  const vencimento = new Date(
    comp.getFullYear(),
    comp.getMonth(),
    diaVencimento
  )

  if(hoje > vencimento) return 'Vencido'
  return 'Em aberto'
}

/* ========================
 HISTÓRICO FINANCEIRO
======================== */

async function carregarHistorico(){

  tabela.innerHTML = ''

  const { data: mensalidades } = await supabase
    .from('mensalidades')
    .select('*')
    .eq('aluno_id', alunoId)

  const { data: pagamentos } = await supabase
    .from('pagamentos')
    .select('*')
    .eq('aluno_id', alunoId)

  mensalidades.forEach(m => {

    const competencias = gerarCompetencias(
      m.data_inicio,
      m.data_fim
    )

    competencias.forEach(comp => {

      const competenciaISO =
        comp.toISOString().slice(0,7) + '-01'

      const pago = pagamentos.find(p =>
        p.mensalidade_id === m.id_mensalidade &&
        p.competencia === competenciaISO
      )

      const status = calcularStatus(
        comp,
        m.dia_vencimento,
        !!pago
      )

      const competenciaFmt =
        String(comp.getMonth()+1).padStart(2,'0')
        + '/' + comp.getFullYear()

      tabela.innerHTML += `
        <tr>
          <td>${competenciaFmt}</td>
          <td>R$ ${Number(m.valor).toFixed(2)}</td>
          <td>Dia ${m.dia_vencimento}</td>
          <td>${status}</td>
        </tr>
      `
    })
  })
}

carregarHistorico()

</script>

</body>
</html>
