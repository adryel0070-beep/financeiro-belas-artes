<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Financeiro do Aluno</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>
</head>

<body>

<h1>Financeiro do Aluno</h1>
<h2 id="nomeAluno"></h2>

<!-- =========================
 CADASTRO DE MENSALIDADE (CONTRATO)
========================= -->

<form id="formMensalidade" class="form">

<label>
Valor da Mensalidade
<input type="number" step="0.01" id="valor" required>
</label>

<label>
Dia do Vencimento
<input type="number" id="vencimento" min="1" max="28" required>
</label>

<label>
Início da Vigência
<input type="month" id="inicio" required>
</label>

<label>
Fim da Vigência
<input type="month" id="fim" required>
</label>

<button type="submit">Salvar Mensalidade</button>

</form>

<p id="msg"></p>

<hr>

<!-- =========================
 HISTÓRICO FINANCEIRO
========================= -->

<h2>Histórico Financeiro</h2>

<table>
<thead>
<tr>
<th>Competência</th>
<th>Valor</th>
<th>Dia do Vencimento</th>
</tr>
</thead>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'

const params = new URLSearchParams(window.location.search)
const alunoId = params.get('id')

const nomeAluno = document.getElementById('nomeAluno')
const tabela = document.getElementById('tabela')
const msg = document.getElementById('msg')

/* ========================
 FUNÇÕES SEGURAS DE DATA
======================== */

function criarDataSegura(ano, mes){
  return new Date(ano, mes, 1, 12) // meio-dia evita bug de fuso
}

function gerarCompetencias(inicio, fim){
  const [anoIni, mesIni] = inicio.split('-').map(Number)
  const [anoFim, mesFim] = fim.split('-').map(Number)

  let atual = criarDataSegura(anoIni, mesIni - 1)
  const limite = criarDataSegura(anoFim, mesFim - 1)

  const lista = []

  while(atual <= limite){
    lista.push(new Date(atual))
    atual.setMonth(atual.getMonth() + 1)
  }

  return lista
}

function formatarCompetencia(date){
  const mes = String(date.getMonth()+1).padStart(2,'0')
  const ano = date.getFullYear()
  return `${mes}/${ano}`
}

/* ========================
 CARREGAR ALUNO
======================== */

async function carregarAluno(){
  const { data } = await supabase
    .from('alunos')
    .select('nome')
    .eq('id', alunoId)
    .single()

  if(data) nomeAluno.innerText = data.nome
}

carregarAluno()

/* ========================
 SALVAR MENSALIDADE
======================== */

document.getElementById('formMensalidade')
.addEventListener('submit', async (e) => {

  e.preventDefault()
  msg.innerText = ''

  const valor = Number(document.getElementById('valor').value)
  const dia = Number(document.getElementById('vencimento').value)
  const inicio = document.getElementById('inicio').value
  const fim = document.getElementById('fim').value

  if(inicio > fim){
    msg.innerText = 'Fim da vigência não pode ser menor que o início'
    msg.style.color = 'red'
    return
  }

  const { error } = await supabase
    .from('mensalidades')
    .insert({
      aluno_id: alunoId,
      valor,
      dia_vencimento: dia,
      data_inicio: inicio + '-01',
      data_fim: fim + '-01'
    })

  if(error){
    msg.innerText = 'Erro ao salvar mensalidade'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Mensalidade cadastrada com sucesso'
  msg.style.color = 'green'

  document.getElementById('formMensalidade').reset()
  carregarHistorico()
})

/* ========================
 HISTÓRICO FINANCEIRO
======================== */

async function carregarHistorico(){

  tabela.innerHTML = ''

  const { data: mensalidades } = await supabase
    .from('mensalidades')
    .select('*')
    .eq('aluno_id', alunoId)

  if(!mensalidades || mensalidades.length === 0){
    tabela.innerHTML = `
      <tr>
        <td colspan="3" style="text-align:center;">
          Nenhuma mensalidade cadastrada
        </td>
      </tr>
    `
    return
  }

  // ordenar contratos por início
  mensalidades.sort((a,b) =>
    new Date(a.data_inicio) - new Date(b.data_inicio)
  )

  mensalidades.forEach(m => {

    const competencias = gerarCompetencias(
      m.data_inicio,
      m.data_fim
    )

    competencias.forEach(comp => {

      const competenciaFmt =
        String(comp.getMonth()+1).padStart(2,'0')
        + '/' + comp.getFullYear()

      tabela.innerHTML += `
        <tr>
          <td>${competenciaFmt}</td>
          <td>R$ ${Number(m.valor).toFixed(2)}</td>
          <td>Dia ${m.dia_vencimento}</td>
        </tr>
      `
    })
  })
}

carregarHistorico()
</script>

</body>
</html>



