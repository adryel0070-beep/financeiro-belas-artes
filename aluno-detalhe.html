<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Histórico do Aluno</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1 id="nomeAluno">Aluno</h1>

<section class="cards">
  <div class="card">
    <h3>Mensalidade</h3>
    <p id="mensalidade">R$ --</p>
  </div>

  <div class="card">
    <h3>Total Pago</h3>
    <p id="totalPago">R$ --</p>
  </div>
</section>

<h2>Histórico de Pagamentos</h2>

<table>
<thead>
  <tr>
    <th>Competência</th>
    <th>Valor</th>
    <th>Pago</th>
    <th>Status</th>
  </tr>
</thead>
  <tbody id="tabelaPagamentos"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'
import { protegerPagina } from './auth.js'

protegerPagina()

const params = new URLSearchParams(window.location.search)
const alunoId = params.get('id')

async function carregarAluno() {
  const { data } = await supabase
    .from('alunos')
    .select('*')
    .eq('id', alunoId)
    .single()

  document.getElementById('nomeAluno').innerText = data.nome
  document.getElementById('mensalidade').innerText =
    `R$ ${Number(data.valor_mensalidade).toFixed(2)}`
}

async function carregarPagamentos() {
  const { data } = await supabase
    .from('vw_status_pagamentos')
    .select('*')
    .eq('aluno_id', alunoId)

  const tbody = document.getElementById('tabelaPagamentos')
  tbody.innerHTML = ''

  let total = 0

  data.forEach(p => {
    total += Number(p.total_pago)

    const mes = new Date(p.competencia)
      .toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })

    let cor = 'gray'
    if (p.status === 'PAGO') cor = 'green'
    if (p.status === 'EM ABERTO') cor = 'red'
    if (p.status === 'A VENCER') cor = 'orange'

    tbody.innerHTML += `
      <tr>
        <td>${mes}</td>
        <td>R$ ${Number(p.valor_mensalidade).toFixed(2)}</td>
        <td>R$ ${Number(p.total_pago).toFixed(2)}</td>
        <td style="font-weight:bold;color:${cor}">
          ${p.status}
        </td>
      </tr>
    `
  })

  document.getElementById('totalPago').innerText =
    `R$ ${total.toFixed(2)}`
}

  const tbody = document.getElementById('tabelaPagamentos')
  tbody.innerHTML = ''

  let total = 0

  data.forEach(p => {
    total += Number(p.valor_pago)

    const mes = new Date(p.competencia)
      .toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })

    tbody.innerHTML += `
      <tr>
        <td>${mes}</td>
        <td>R$ ${Number(p.valor_pago).toFixed(2)}</td>
        <td>${p.forma_pagamento}</td>
      </tr>
    `
  })

  document.getElementById('totalPago').innerText =
    `R$ ${total.toFixed(2)}`

carregarAluno()
carregarPagamentos()
</script>

</body>
</html>
