<!DOCTYPE html>
<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>

<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Financeiro do Aluno</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Financeiro do Aluno</h1>
<h2 id="nomeAluno"></h2>

<!-- =========================
 CADASTRO DE MENSALIDADES
========================= -->

<form id="formMensalidade" class="form">

  <label>
    Valor da Mensalidade
    <input type="number" step="0.01" id="valor" required>
  </label>

  <label>
    Dia do Vencimento
    <input type="number" id="vencimento" min="1" max="28" required>
  </label>

  <label>
    InÃ­cio da VigÃªncia
    <input type="month" id="inicio" required>
  </label>

  <label>
    Fim da VigÃªncia
    <input type="month" id="fim" required>
  </label>

  <button type="submit">Gerar Mensalidades</button>
</form>

<p id="msg" class="mensagem"></p>

<hr>

<!-- =========================
 HISTÃ“RICO FINANCEIRO
========================= -->

<h2>Mensalidades Geradas</h2>

<table>
<thead>
<tr>
<th>CompetÃªncia</th>
<th>Valor</th>
<th>Vencimento</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tabelaMensalidades"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'

const params = new URLSearchParams(window.location.search)
const alunoId = params.get('id')

const nomeAluno = document.getElementById('nomeAluno')
const tabela = document.getElementById('tabelaMensalidades')
const msg = document.getElementById('msg')

/* ========================
 CARREGAR ALUNO
======================== */

async function carregarAluno() {
  const { data, error } = await supabase
    .from('alunos')
    .select('nome')
    .eq('id', alunoId)
    .single()

  if (!error) nomeAluno.innerText = data.nome
}

carregarAluno()

/* ========================
 GERAR MENSALIDADES
======================== */

document.getElementById('formMensalidade')
.addEventListener('submit', async (e) => {

  e.preventDefault()
  msg.innerText = ''

  const valor = Number(document.getElementById('valor').value)
  const dia = Number(document.getElementById('vencimento').value)
  const inicio = document.getElementById('inicio').value
  const fim = document.getElementById('fim').value

  if (inicio > fim) {
    msg.innerText = 'Fim da vigÃªncia nÃ£o pode ser menor que o inÃ­cio'
    msg.style.color = 'red'
    return
  }

  let dataAtual = new Date(inicio + '-01')
  const dataFim = new Date(fim + '-01')

  const novasMensalidades = []

  while (dataAtual <= dataFim) {

    novasMensalidades.push({
      aluno_id: alunoId,
      competencia: dataAtual.toISOString().slice(0,10),
      valor: valor,
      dia_vencimento: dia
    })

    dataAtual.setMonth(dataAtual.getMonth() + 1)
  }

  // ğŸ”’ Remove competÃªncias jÃ¡ existentes
  const { data: existentes } = await supabase
    .from('mensalidades')
    .select('competencia')
    .eq('aluno_id', alunoId)

  const competenciasExistentes = existentes.map(m => m.competencia)

  const paraInserir = novasMensalidades.filter(
    m => !competenciasExistentes.includes(m.competencia)
  )

  if (paraInserir.length === 0) {
    msg.innerText = 'Nenhuma nova mensalidade para gerar'
    msg.style.color = 'orange'
    return
  }

  const { error } = await supabase
    .from('mensalidades')
    .insert(paraInserir)

  if (error) {
    msg.innerText = 'Erro ao gerar mensalidades'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Mensalidades geradas com sucesso!'
  msg.style.color = 'green'

  carregarMensalidades()
})

/* ========================
 STATUS AUTOMÃTICO
======================== */

function calcularStatus(m) {

  if (m.pagamentos.length > 0) return 'Pago'

  const hoje = new Date()
  const comp = new Date(m.competencia)
  const venc = new Date(
    comp.getFullYear(),
    comp.getMonth(),
    m.dia_vencimento
  )

  if (hoje > venc) return 'Vencido'

  return 'Em aberto'
}

/* ========================
 LISTAR MENSALIDADES
======================== */

async function carregarMensalidades() {

  const { data, error } = await supabase
    .from('mensalidades')
    .select(`
      competencia,
      valor,
      dia_vencimento,
      pagamentos(id)
    `)
    .eq('aluno_id', alunoId)
    .order('competencia')

  if (error) {
    console.error(error)
    return
  }

  tabela.innerHTML = ''

  data.forEach(m => {

    const comp = new Date(m.competencia)
    const competenciaFormatada =
      String(comp.getMonth()+1).padStart(2,'0') +
      '/' + comp.getFullYear()

    const status = calcularStatus(m)

    tabela.innerHTML += `
      <tr>
        <td>${competenciaFormatada}</td>
        <td>R$ ${Number(m.valor).toFixed(2)}</td>
        <td>Dia ${m.dia_vencimento}</td>
        <td>${status}</td>
      </tr>
    `
  })
}

carregarMensalidades()
</script>

</body>
</html>
