<!DOCTYPE html>
<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>

<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Alunos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Cadastro de Aluno</h1>

<form id="formAluno" class="form">

  <input type="hidden" id="aluno_id">

  <label>
    Nome do Aluno
    <input type="text" id="nome" required>
  </label>

  <label>
    Telefone / WhatsApp
    <input type="text" id="telefone">
  </label>

  <label>
    Email
    <input type="email" id="email">
  </label>

  <label>
    Instrumento
    <input type="text" id="instrumento">
  </label>

  <label>
    Data de Nascimento
    <input type="date" id="data_nascimento">
  </label>

  <button type="submit" id="btnSalvar">Cadastrar Aluno</button>
</form>

<p id="mensagem" class="mensagem"></p>

<h2>Alunos Cadastrados</h2>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Instrumento</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="listaAlunos"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'

const form = document.getElementById('formAluno')
const msg  = document.getElementById('mensagem')
const btnSalvar = document.getElementById('btnSalvar')

let alunoEditandoId = null

form.addEventListener('submit', async (e) => {
  e.preventDefault()

  const aluno = {
    nome: nome.value,
    telefone: telefone.value,
    email: email.value,
    instrumento: instrumento.value,
    data_nascimento: data_nascimento.value || null
  }

  let resposta

  if (alunoEditandoId) {
    resposta = await supabase
      .from('alunos')
      .update(aluno)
      .eq('id', alunoEditandoId)
  } else {
    aluno.data_matricula = new Date().toISOString().slice(0, 10)
    aluno.ativo = true

    resposta = await supabase
      .from('alunos')
      .insert(aluno)
  }

  if (resposta.error) {
    msg.innerText = 'Erro ao salvar aluno'
    msg.style.color = 'red'
    console.error(resposta.error)
    return
  }

  msg.innerText = alunoEditandoId
    ? 'Aluno atualizado com sucesso!'
    : 'Aluno cadastrado com sucesso!'

  msg.style.color = 'green'
  form.reset()
  alunoEditandoId = null
  btnSalvar.innerText = 'Cadastrar Aluno'
  listarAlunos()
})

async function listarAlunos() {
  const { data, error } = await supabase
    .from('alunos')
    .select('*')
    .order('nome')

  if (error) {
    console.error(error)
    return
  }

  const tbody = document.getElementById('listaAlunos')
  tbody.innerHTML = ''

  data.forEach(aluno => {
    tbody.innerHTML += `
      <tr>
        <td>${aluno.nome}</td>
        <td>${aluno.instrumento ?? '-'}</td>
        <td>
          <button onclick="editarAluno('${aluno.id}')">Editar</button>
          <a href="mensalidades.html?aluno=${aluno.id}">Financeiro</a>
        </td>
      </tr>
    `
  })
}

window.editarAluno = async (id) => {
  const { data, error } = await supabase
    .from('alunos')
    .select('*')
    .eq('id', id)
    .single()

  if (error) {
    console.error(error)
    return
  }

  alunoEditandoId = id

  nome.value = data.nome
  telefone.value = data.telefone ?? ''
  email.value = data.email ?? ''
  instrumento.value = data.instrumento ?? ''
  data_nascimento.value = data.data_nascimento ?? ''

  btnSalvar.innerText = 'Salvar Alterações'
}

listarAlunos()
</script>

</body>
</html>
