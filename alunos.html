<!DOCTYPE html>
<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>

<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Cadastro de Alunos</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Cadastro de Aluno</h1>

<form id="formAluno" class="form">

  <label>
    Nome do Aluno
    <input type="text" id="nome" required>
  </label>

  <label>
    Telefone / WhatsApp
    <input type="text" id="telefone" placeholder="(99) 99999-9999">
  </label>

  <label>
    Email
    <input type="email" id="email">
  </label>

  <label>
    Instrumento
    <input type="text" id="instrumento">
  </label>

  <label>
    Data de Nascimento
    <input type="date" id="data_nascimento">
  </label>

  <button type="submit">Cadastrar Aluno</button>
</form>

<p id="mensagem" class="mensagem"></p>

<h2>Alunos Cadastrados</h2>

<table>
<thead>
<tr>
<th>Nome</th>
<th>Instrumento</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="listaAlunos"></tbody>
</table>

<script type="module">
import { supabase } from './supabase.js'

const form = document.getElementById('formAluno')
const msg  = document.getElementById('mensagem')

form.addEventListener('submit', async (e) => {
  e.preventDefault()

  const aluno = {
    nome: document.getElementById('nome').value,
    telefone: document.getElementById('telefone').value,
    email: document.getElementById('email').value,
    instrumento: document.getElementById('instrumento').value,
    data_nascimento: document.getElementById('data_nascimento').value || null,
    data_matricula: new Date().toISOString().slice(0,10),
    ativo: true
  }

  const { error } = await supabase
    .from('alunos')
    .insert(aluno)

  if (error) {
    msg.innerText = 'Erro ao cadastrar aluno'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Aluno cadastrado com sucesso!'
  msg.style.color = 'green'
  form.reset()
  listarAlunos()
})

async function listarAlunos() {
  const { data } = await supabase
    .from('alunos')
    .select('*')
    .order('nome')

  const tbody = document.getElementById('listaAlunos')
  tbody.innerHTML = ''

  data.forEach(aluno => {
    tbody.innerHTML += `
      <tr>
        <td>${aluno.nome}</td>
        <td>${aluno.instrumento ?? '-'}</td>
        <td>
          <a href="aluno-detalhe.html?id=${aluno.id}">
            Financeiro
          </a>
        </td>
      </tr>
    `
  })
}

listarAlunos()
</script>

</body>
</html>
