<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Histórico de Pagamentos</title>
  <link rel="stylesheet" href="style.css">

  <script type="module">
    import { protegerPagina } from './auth.js'
    protegerPagina()
  </script>
</head>

<body>

<h1>Histórico de Pagamentos</h1>

<section class="form">

  <label>
    Aluno
    <select id="aluno">
      <option value="">Selecione um aluno</option>
    </select>
  </label>

</section>

<table class="tabela" id="tabela">
  <thead>
    <tr>
      <th>Competência</th>
      <th>Valor</th>
      <th>Forma</th>
      <th>Data do Pagamento</th>
      <th>Status</th>
      <th>Recibo</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr>
      <td colspan="6" style="text-align:center;">Selecione um aluno</td>
    </tr>
  </tbody>
</table>

<p id="mensagem" class="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const selectAluno = document.getElementById('aluno')
const tbody = document.getElementById('tbody')
const msg = document.getElementById('mensagem')

// =======================
// Carregar alunos ativos
// =======================
async function carregarAlunos() {
  const { data, error } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  if (error) {
    msg.innerText = 'Erro ao carregar alunos'
    msg.style.color = 'red'
    return
  }

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    selectAluno.appendChild(opt)
  })
}

carregarAlunos()

// =======================
// Buscar histórico
// =======================
selectAluno.addEventListener('change', async () => {
  const alunoId = selectAluno.value
  tbody.innerHTML = ''

  if (!alunoId) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center;">Selecione um aluno</td>
      </tr>
    `
    return
  }

  const { data, error } = await supabase
    .from('vw_status_pagamento')
    .select('*')
    .eq('aluno_id', alunoId)
    .order('competencia', { ascending: false })

  if (error) {
    msg.innerText = 'Erro ao carregar histórico'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  if (data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:center;">Nenhum pagamento encontrado</td>
      </tr>
    `
    return
  }

  data.forEach(p => {
    const statusClass = p.status === 'PAGO' ? 'status-pago' : 'status-aberto'
    const dataPagamento = p.data_pagamento
      ? new Date(p.data_pagamento).toLocaleDateString('pt-BR')
      : '-'

    const btnRecibo = p.status === 'PAGO'
      ? `<a href="recibo.html?id=${p.id}" target="_blank">Abrir</a>`
      : '-'

    tbody.innerHTML += `
      <tr>
        <td>${new Date(p.competencia).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</td>
        <td>R$ ${Number(p.valor_pago ?? p.valor_mensalidade).toFixed(2)}</td>
        <td>${p.forma_pagamento ?? '-'}</td>
        <td>${dataPagamento}</td>
        <td><span class="${statusClass}">${p.status}</span></td>
        <td>${btnRecibo}</td>
      </tr>
    `
  })
})
</script>

</body>
</html>
