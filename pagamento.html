<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Registro de Pagamento</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>
</head>

<body>

<h1>Registrar Pagamento</h1>

<form id="formPagamento" class="form">

<label>
Aluno
<select id="aluno" required>
<option value="">Selecione o aluno</option>
</select>
</label>

<label>
Competência em Aberto
<select id="competencia" required disabled>
<option value="">Selecione a competência</option>
</select>
</label>

<label>
Valor (R$)
<input type="number" id="valor" step="0.01" readonly>
</label>

<label>
Forma de Pagamento
<select id="forma" required>
<option value="Pix">Pix</option>
<option value="Dinheiro">Dinheiro</option>
<option value="Transferência">Transferência</option>
</select>
</label>

<label>
Data do Pagamento
<input type="date" id="dataPagamento" required>
</label>

<button type="submit">Confirmar Pagamento</button>

</form>

<p id="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const alunoSelect = document.getElementById('aluno')
const competenciaSelect = document.getElementById('competencia')
const valorInput = document.getElementById('valor')
const dataPagamentoInput = document.getElementById('dataPagamento')
const msg = document.getElementById('mensagem')
const form = document.getElementById('formPagamento')

// data padrão hoje
dataPagamentoInput.value = new Date().toISOString().slice(0,10)

// =======================
// carregar alunos
// =======================
async function carregarAlunos(){
  const { data } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    alunoSelect.appendChild(opt)
  })
}
carregarAlunos()

// =======================
// gerar competências
// =======================
function gerarCompetencias(inicio, fim){
  const lista = []
  let atual = new Date(inicio)
  const dataFim = new Date(fim)

  while(atual <= dataFim){
    lista.push(new Date(atual))
    atual.setMonth(atual.getMonth() + 1)
  }
  return lista
}

// =======================
// ao selecionar aluno
// =======================
alunoSelect.addEventListener('change', async () => {

  competenciaSelect.innerHTML = `<option value="">Selecione a competência</option>`
  competenciaSelect.disabled = true
  valorInput.value = ''
  msg.innerText = ''

  if(!alunoSelect.value) return

  const alunoId = alunoSelect.value

  const { data: mensalidade } = await supabase
    .from('mensalidades')
    .select('*')
    .eq('aluno_id', alunoId)
    .maybeSingle()

  if(!mensalidade){
    msg.innerText = 'Aluno sem mensalidade cadastrada'
    msg.style.color = 'red'
    return
  }

  const { data: pagamentos } = await supabase
    .from('pagamentos')
    .select('competencia')
    .eq('aluno_id', alunoId)
    .eq('mensalidade_id', mensalidade.id_mensalidade)

  const competencias = gerarCompetencias(
    mensalidade.data_inicio,
    mensalidade.data_fim
  )

  const abertas = competencias.filter(c => {
    const compISO = c.toISOString().slice(0,7) + '-01'
    return !pagamentos.some(p => p.competencia === compISO)
  })

  abertas.forEach(c => {

    const compISO = c.toISOString().slice(0,7) + '-01'
    const compFmt =
      String(c.getMonth()+1).padStart(2,'0') + '/' + c.getFullYear()

    const opt = document.createElement('option')
    opt.value = compISO
    opt.textContent = `${compFmt} | Venc. dia ${mensalidade.dia_vencimento}`
    opt.dataset.valor = mensalidade.valor
    opt.dataset.mensalidade = mensalidade.id_mensalidade

    competenciaSelect.appendChild(opt)
  })

  if(abertas.length === 0){
    msg.innerText = 'Nenhuma competência em aberto'
    msg.style.color = 'green'
    return
  }

  competenciaSelect.disabled = false
})

// =======================
// ao escolher competência
// =======================
competenciaSelect.addEventListener('change', () => {
  const opt = competenciaSelect.selectedOptions[0]
  valorInput.value = opt?.dataset.valor ?? ''
})

// =======================
// registrar pagamento
// =======================
form.addEventListener('submit', async (e) => {
  e.preventDefault()

  const opt = competenciaSelect.selectedOptions[0]
  if(!opt) return

  const pagamento = {
    aluno_id: alunoSelect.value,
    mensalidade_id: opt.dataset.mensalidade,
    competencia: opt.value,
    valor_pago: valorInput.value,
    forma_pagamento: document.getElementById('forma').value,
    data_pagamento: dataPagamentoInput.value
  }

  const { error } = await supabase
    .from('pagamentos')
    .insert(pagamento)

  if(error){
    msg.innerText = 'Erro ao registrar pagamento'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Pagamento registrado com sucesso!'
  msg.style.color = 'green'
  form.reset()
  competenciaSelect.disabled = true
})
</script>

</body>
</html>
