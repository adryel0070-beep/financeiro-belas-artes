<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Registro de Pagamento</title>
  <link rel="stylesheet" href="style.css">

  <script type="module">
    import { protegerPagina } from './auth.js'
    protegerPagina()
  </script>
</head>

<body>

<h1>Registro de Pagamento</h1>

<form id="formPagamento" class="form">

  <label>
    Aluno
    <select id="aluno" required>
      <option value="">Selecione um aluno</option>
    </select>
  </label>

  <label>
    CompetÃªncia
    <input type="month" id="competencia" required>
  </label>

  <label>
    Valor Pago (R$)
    <input type="number" step="0.01" id="valor" min="0" required>
  </label>

  <label>
    Forma de Pagamento
    <select id="forma" required>
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="TransferÃªncia">TransferÃªncia</option>
    </select>
  </label>

  <button type="submit">Registrar Pagamento</button>
</form>

<p id="mensagem" class="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const selectAluno = document.getElementById('aluno')
const form = document.getElementById('formPagamento')
const msg = document.getElementById('mensagem')

// =======================
// Carregar alunos ativos
// =======================
async function carregarAlunos() {
  const { data, error } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  if (error) {
    msg.innerText = 'Erro ao carregar alunos'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    selectAluno.appendChild(opt)
  })
}

carregarAlunos()

// =======================
// Registrar pagamento
// =======================
form.addEventListener('submit', async (e) => {
  e.preventDefault()
  msg.innerText = ''

  const alunoId = selectAluno.value
  const competencia = document.getElementById('competencia').value
  const valor = document.getElementById('valor').value
  const forma = document.getElementById('forma').value

  if (!alunoId || !competencia || !valor) {
    msg.innerText = 'Preencha todos os campos'
    msg.style.color = 'red'
    return
  }

  // ðŸ”’ Verifica se jÃ¡ existe pagamento nessa competÃªncia
  const { data: existente } = await supabase
    .from('pagamentos')
    .select('id')
    .eq('aluno_id', alunoId)
    .eq('competencia', competencia + '-01')
    .maybeSingle()

  if (existente) {
    msg.innerText = 'Este aluno jÃ¡ possui pagamento nesta competÃªncia'
    msg.style.color = 'red'
    return
  }

  const pagamento = {
    aluno_id: alunoId,
    competencia: competencia + '-01',
    valor_pago: valor,
    forma_pagamento: forma
  }

  const { data, error } = await supabase
    .from('pagamentos')
    .insert(pagamento)
    .select()
    .single()

  if (error) {
    msg.innerText = 'Erro ao registrar pagamento'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Pagamento registrado com sucesso!'
  msg.style.color = 'green'
  form.reset()

  // ðŸ§¾ Abre recibo em nova aba
  window.open(`recibo.html?id=${data.id}`, '_blank')
})
</script>

</body>
</html>