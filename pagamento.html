<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Registro de Pagamento</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { protegerPagina } from './auth.js'
protegerPagina()
</script>
</head>

<body>

<h1>Registrar Pagamento</h1>

<form id="formPagamento" class="form">

<label>
Aluno
<select id="aluno" required>
<option value="">Selecione o aluno</option>
</select>
</label>

<label>
Competência em Aberto
<select id="competencia" required disabled>
<option value="">Selecione a competência</option>
</select>
</label>

<label>
Valor (R$)
<input type="number" id="valor" step="0.01" readonly>
</label>

<label>
Forma de Pagamento
<select id="forma" required>
<option value="Pix">Pix</option>
<option value="Dinheiro">Dinheiro</option>
<option value="Transferência">Transferência</option>
</select>
</label>

<label>
Data do Pagamento
<input type="date" id="dataPagamento" required>
</label>

<button type="submit">Confirmar Pagamento</button>

</form>

<p id="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const alunoSelect = document.getElementById('aluno')
const mensalidadeSelect = document.getElementById('competencia')
const valorInput = document.getElementById('valor')
const dataPagamentoInput = document.getElementById('dataPagamento')
const msg = document.getElementById('mensagem')
const form = document.getElementById('formPagamento')

// data padrão
dataPagamentoInput.value = new Date().toISOString().slice(0,10)

/* ========================
 UTIL
======================== */
function gerarCompetencias(inicio, fim){
  const lista = []
  let atual = new Date(inicio)
  const dataFim = new Date(fim)

  while(atual <= dataFim){
    lista.push(new Date(atual))
    atual.setMonth(atual.getMonth() + 1)
  }
  return lista
}

/* ========================
 CARREGAR ALUNOS
======================== */
async function carregarAlunos(){
  const { data } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    alunoSelect.appendChild(opt)
  })
}
carregarAlunos()

/* ========================
 AO SELECIONAR ALUNO
======================== */
alunoSelect.addEventListener('change', async () => {

  mensalidadeSelect.innerHTML =
    `<option value="">Selecione a competência</option>`
  mensalidadeSelect.disabled = true
  valorInput.value = ''

  if (!alunoSelect.value) return

  const alunoId = alunoSelect.value

  // contratos
  const { data: mensalidades } = await supabase
    .from('mensalidades')
    .select('*')
    .eq('aluno_id', alunoId)

  // pagamentos
  const { data: pagamentos } = await supabase
    .from('pagamentos')
    .select('mensalidade_id, competencia')
    .eq('aluno_id', alunoId)

  mensalidades.forEach(m => {

    const competencias = gerarCompetencias(
      m.data_inicio,
      m.data_fim
    )

    competencias.forEach(c => {

      const competenciaISO =
        c.toISOString().slice(0,7) + '-01'

      const vencimento = new Date(
        c.getFullYear(),
        c.getMonth(),
        m.dia_vencimento
      )

      if (new Date() <= vencimento) return

      const pago = pagamentos.some(p =>
        p.mensalidade_id === m.id_mensalidade &&
        p.competencia === competenciaISO
      )

      if (pago) return

      const opt = document.createElement('option')
      opt.value = `${m.id}|${competenciaISO}`
      opt.textContent =
        `${String(c.getMonth()+1).padStart(2,'0')}/${c.getFullYear()}
         | R$ ${Number(m.valor).toFixed(2)}
         | Venc. dia ${m.dia_vencimento}`

      opt.dataset.valor = m.valor
      mensalidadeSelect.appendChild(opt)
    })
  })

  mensalidadeSelect.disabled = false
})

/* ========================
 AO SELECIONAR COMPETÊNCIA
======================== */
mensalidadeSelect.addEventListener('change', () => {
  const opt = mensalidadeSelect.selectedOptions[0]
  valorInput.value = opt?.dataset.valor ?? ''
})

/* ========================
 REGISTRAR PAGAMENTO
======================== */
form.addEventListener('submit', async (e) => {
  e.preventDefault()

  if (!mensalidadeSelect.value) {
    msg.innerText = 'Selecione a mensalidade'
    msg.style.color = 'red'
    return
  }

  const [mensalidadeId, competencia] =
    mensalidadeSelect.value.split('|')

  const pagamento = {
    aluno_id: alunoSelect.value,
    mensalidade_id: mensalidadeId,
    competencia: competencia,
    valor_pago: valorInput.value,
    data_pagamento: dataPagamentoInput.value,
    forma_pagamento: document.getElementById('forma').value
  }

  const { error, data } = await supabase
    .from('pagamentos')
    .insert(pagamento)
    .select()
    .single()

  if (error) {
    console.error(error)
    msg.innerText = 'Erro ao registrar pagamento'
    msg.style.color = 'red'
    return
  }

  msg.innerText = 'Pagamento registrado com sucesso!'
  msg.style.color = 'green'
  form.reset()

  window.open(`recibo.html?id=${data.id}`, '_blank')
})
</script>
  
</body>
</html>



