<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Registro de Pagamento</title>
  <link rel="stylesheet" href="style.css">

  <script type="module">
    import { protegerPagina } from './auth.js'
    protegerPagina()
  </script>
</head>

<body>

<h1>Registrar Pagamento</h1>

<form id="formPagamento" class="form">

  <label>
    Aluno
    <select id="aluno" required>
      <option value="">Selecione o aluno</option>
    </select>
  </label>

  <label>
    Mensalidade (Competência)
    <select id="mensalidade" required disabled>
      <option value="">Selecione a mensalidade</option>
    </select>
  </label>

  <label>
    Valor (R$)
    <input type="number" id="valor" step="0.01" readonly>
  </label>

  <label>
    Forma de Pagamento
    <select id="forma" required>
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Transferência">Transferência</option>
    </select>
  </label>

  <label>
    Data do Pagamento
    <input type="date" id="dataPagamento" required>
  </label>

  <button type="submit">Confirmar Pagamento</button>

</form>

<p id="mensagem" class="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const alunoSelect = document.getElementById('aluno')
const mensalidadeSelect = document.getElementById('mensalidade')
const valorInput = document.getElementById('valor')
const dataPagamentoInput = document.getElementById('dataPagamento')
const msg = document.getElementById('mensagem')
const form = document.getElementById('formPagamento')

// =======================
// Data padrão hoje
// =======================
dataPagamentoInput.value = new Date().toISOString().slice(0,10)

// =======================
// Carregar alunos ativos
// =======================
async function carregarAlunos() {
  const { data } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    alunoSelect.appendChild(opt)
  })
}

carregarAlunos()

// =======================
// Ao selecionar aluno
// =======================
alunoSelect.addEventListener('change', async () => {

  mensalidadeSelect.innerHTML = `<option value="">Selecione a mensalidade</option>`
  mensalidadeSelect.disabled = true
  valorInput.value = ''

  if (!alunoSelect.value) return

  const { data } = await supabase
    .from('mensalidades')
    .select(`
      id,
      competencia,
      valor,
      dia_vencimento,
      pagamentos(id)
    `)
    .eq('aluno_id', alunoSelect.value)
    .order('competencia')

  const abertas = data.filter(m => m.pagamentos.length === 0)

  abertas.forEach(m => {

    const comp = new Date(m.competencia)
    const competenciaFormatada =
      (comp.getMonth()+1).toString().padStart(2,'0') + '/' + comp.getFullYear()

    const opt = document.createElement('option')
    opt.value = m.id
    opt.textContent = `${competenciaFormatada} | R$ ${Number(m.valor).toFixed(2)} | Venc. dia ${m.dia_vencimento}`
    opt.dataset.valor = m.valor

    mensalidadeSelect.appendChild(opt)
  })

  mensalidadeSelect.disabled = false
})

// =======================
// Ao selecionar mensalidade
// =======================
mensalidadeSelect.addEventListener('change', () => {
  const opt = mensalidadeSelect.selectedOptions[0]
  valorInput.value = opt?.dataset.valor ?? ''
})

// =======================
// Registrar pagamento
// =======================
form.addEventListener('submit', async (e) => {
  e.preventDefault()

  if (!mensalidadeSelect.value) {
    msg.innerText = 'Selecione uma mensalidade'
    msg.style.color = 'red'
    return
  }

  const pagamento = {
    aluno_id: alunoSelect.value,
    mensalidade_id: mensalidadeSelect.value,
    valor_pago: valorInput.value,
    data_pagamento: dataPagamentoInput.value,
    forma_pagamento: document.getElementById('forma').value
  }

  const { data, error } = await supabase
    .from('pagamentos')
    .insert(pagamento)
    .select()
    .single()

  if (error) {
    msg.innerText = 'Erro ao registrar pagamento'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Pagamento registrado com sucesso!'
  msg.style.color = 'green'
  form.reset()

  // abre recibo
  window.open(`recibo.html?id=${data.id}`, '_blank')
})
</script>

</body>
</html>
