<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Registro de Pagamento</title>
  <link rel="stylesheet" href="style.css">

  <script type="module">
    import { protegerPagina } from './auth.js'
    protegerPagina()
  </script>
</head>

<body>

<h1>Registro de Pagamento</h1>

<form id="formPagamento" class="form">

  <label>
    Aluno
    <select id="aluno" required>
      <option value="">Selecione um aluno</option>
    </select>
  </label>

  <p id="infoMensalidade" style="font-weight:bold;"></p>

  <label>
    CompetÃªncia
    <input type="month" id="competencia" required>
  </label>

  <label>
    Forma de Pagamento
    <select id="forma" required>
      <option value="Pix">Pix</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="TransferÃªncia">TransferÃªncia</option>
    </select>
  </label>

  <button type="submit">Registrar Pagamento</button>
</form>

<p id="mensagem" class="mensagem"></p>

<script type="module">
import { supabase } from './supabase.js'

const selectAluno = document.getElementById('aluno')
const form = document.getElementById('formPagamento')
const msg = document.getElementById('mensagem')
const infoMensalidade = document.getElementById('infoMensalidade')

let mensalidadeAtiva = null

// =======================
// Carregar alunos ativos
// =======================
async function carregarAlunos() {
  const { data, error } = await supabase
    .from('alunos')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')

  if (error) {
    msg.innerText = 'Erro ao carregar alunos'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  data.forEach(a => {
    const opt = document.createElement('option')
    opt.value = a.id
    opt.textContent = a.nome
    selectAluno.appendChild(opt)
  })
}

carregarAlunos()

// =======================
// Buscar mensalidade ativa
// =======================
selectAluno.addEventListener('change', async () => {
  infoMensalidade.innerText = ''
  mensalidadeAtiva = null

  const alunoId = selectAluno.value
  if (!alunoId) return

  const { data, error } = await supabase
    .from('mensalidades')
    .select('*')
    .eq('aluno_id', alunoId)
    .is('data_fim', null)
    .single()

  if (error || !data) {
    infoMensalidade.innerText = 'âš ï¸ Aluno sem mensalidade ativa'
    infoMensalidade.style.color = 'red'
    return
  }

  mensalidadeAtiva = data
  infoMensalidade.innerText =
    `Mensalidade ativa: R$ ${Number(data.valor).toFixed(2)} â€” vencimento dia ${data.dia_vencimento}`
  infoMensalidade.style.color = 'green'
})

// =======================
// Registrar pagamento
// =======================
form.addEventListener('submit', async (e) => {
  e.preventDefault()
  msg.innerText = ''

  if (!mensalidadeAtiva) {
    msg.innerText = 'Este aluno nÃ£o possui mensalidade ativa'
    msg.style.color = 'red'
    return
  }

  const alunoId = selectAluno.value
  const competencia = document.getElementById('competencia').value
  const forma = document.getElementById('forma').value

  if (!alunoId || !competencia) {
    msg.innerText = 'Preencha todos os campos'
    msg.style.color = 'red'
    return
  }

  // ðŸ”’ Verifica pagamento duplicado
  const { data: existente } = await supabase
    .from('pagamentos')
    .select('id')
    .eq('mensalidade_id', mensalidadeAtiva.id)
    .eq('competencia', competencia + '-01')
    .maybeSingle()

  if (existente) {
    msg.innerText = 'Pagamento jÃ¡ registrado para esta competÃªncia'
    msg.style.color = 'red'
    return
  }

  const pagamento = {
    aluno_id: alunoId,
    mensalidade_id: mensalidadeAtiva.id,
    competencia: competencia + '-01',
    valor_pago: mensalidadeAtiva.valor,
    forma_pagamento: forma,
    data_pagamento: new Date().toISOString()
  }

  const { data, error } = await supabase
    .from('pagamentos')
    .insert(pagamento)
    .select()
    .single()

  if (error) {
    msg.innerText = 'Erro ao registrar pagamento'
    msg.style.color = 'red'
    console.error(error)
    return
  }

  msg.innerText = 'Pagamento registrado com sucesso!'
  msg.style.color = 'green'
  form.reset()
  infoMensalidade.innerText = ''
  mensalidadeAtiva = null

  // ðŸ§¾ Abre recibo
  window.open(`recibo.html?id=${data.id}`, '_blank')
})
</script>

</body>
</html>
